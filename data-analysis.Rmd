---
title: "Traffic Data Analysis"
output: html_document
---

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(knitr)
library(stringr)
library(knitr)
```

## First Look on the data

First of all let's read the data

```{r cache=TRUE}
data <- read.csv("traffic-data.csv")
```

Now let's see some stats about the data

```{r}
data %>% dim
data %>% glimpse
data %>% head
data %>% summary
data %>% sapply(function(d) sum(is.na(d)))
```

## Let's Clean the data

### Removing Columns with Unique Values

Let's have a look at the uniqueness of the values in each column

```{r}
data %>% sapply(function(d) length(unique(d)))
```

All those columns with only one unique value are useless to our analysis as they don't distinguish between rows. Also it makes some sense as most of them are ads related and the ads seems to be the same throughout the whole data set. So we will remove all the ads related columns and those columns with only a single value.

```{r}

data <- (
         data %>% select(-c(
                            ad.aid,
                            ad.bgcl,
                            ad.bgcls,
                            ad.fncl,
                            ad.fncls,
                            ad.lid,
                            ad.logo,
                            ad.logo2x,
                            ad.logoAndroidS,
                            ad.logoAndroidH,
                            ad.cm,
                            ad.url,
                            ad.g,
                            rd.cl,
                            rd.img,
                            rd.rp.type,
                            rd.rp.rpImg,
                            rd.rp.img
                            )
         )
 )
```

### Fixing Column Types

According to the structure we saw above, dates are represented as factors. We can convert them to a better format using the `strptime` function and convert it a format that `dplyr` understands using the `as.POSIXct` function.

```{r}

data$crawl_date <- as.POSIXct(strptime(data$crawl_date,  format="%a %b %d %H:%M:%S UTC %Y", tz="UTC") + 60*60*2) # Fixing timezone

#data$rd.rp.nm <- as.character(data$rd.rp.nm)
```

### Removing Useless Columns

Now Let's have another look at the dataset columns and try to infer some info from the column names and values.

```{r}
data %>% glimpse
data %>% select(rd.new, rd.strq, rd.cmrq) %>% sapply(function(d) unique(d))
```

The `rd.strq` and `rd.cmrq` are boolean properties of the road. After some investigation, I found that they don't have any presence in the HTML/JS of the desktop version of By2ollak. My guess would be that they are for the mobile version to determine whether choosing a status/adding a comment is required or not when leaving a report. This would be confirmed if there isn't any road who has this flag both set and unset in the same dataset. In other words, the set containing the roads who has the flag set doesn't intersect with the one with the flag unset.

```{r, collapse=TRUE}
data %>% group_by(rd.strq) %>% summarize(c=length(unique(rd.nm)))
sum((data %>% group_by(rd.strq) %>% summarize(c=length(unique(rd.nm))))$c) == (data$rd.nm %>% unique %>% length)

data %>% group_by(rd.cmrq) %>% summarize(c=length(unique(rd.nm)))
sum((data %>% group_by(rd.cmrq) %>% summarize(c=length(unique(rd.nm))))$c) == (data$rd.nm %>% unique %>% length)

data %>% group_by(rd.new) %>% summarize(c=length(unique(rd.nm)))
sum((data %>% group_by(rd.cmrq) %>% summarize(c=length(unique(rd.nm))))$c) == (data$rd.nm %>% unique %>% length)
```

The guess seems to be correct. That's why those columns are not important to us any more.

```{r}
data <- (data %>% select(-c(rd.strq, rd.cmrq, rd.new)))
```

### Column Name Estimations

Those are my estimation for the columns meanings

```
crawl_date   # The date this data was crawled
rd.nm        # The Road name
rd.ri        # Seemed like the road id and was confirmed from By2ollak's HTML
rd.stid      # The Road Status Id ( Lazeez, ... ). Also confirmed from the HTML
rd.hr        # The road status last updated hour
rd.mn        # The road status last updated minute
rd.rp.nm     # Username of reporter
rd.rp.fullnm # Full name of reporter
rd.rp.hr     # Road report hours ago created
rd.rp.mn     # Road report minutes ago created
rd.rp.stid   # The reporter's reported road status
rd.rp.cm     # The reporter's comment
rd.rp.cmid   # Report id
```

### Removing Duplicate Rows

One of those columns seems very interesting. It's the `rd.rp.cmid`. It's the column representing the report Id. Since these dataset is all about reports, this column's values should be globally unique across the whole dataset.

```{r}
data %>% dim
data$rd.rp.cmid %>% unique %>% length
```

Aaaaand It's not. That's due to the way the data was collected. A cronjob runs every 30 minutes to fetch the latest reports, but the same reports could be fetched multiple time specially if they are on an inactive road. Let's keep only the first copy of each report.

```{r}
data <- data[!(data$rd.rp.cmid %>% duplicated),]
```

Now that we have a clean, ready to use data, let's start adding some more useful features to it.

## Feature Engineering

### Extracting the Exact Report Time

Let's see the timings people report

```{r}
data %>% separate(crawl_date, into=c("crawl_date_tmp","crawl_time"), sep =" ") %>% mutate(crawl_time=as.POSIXct(strptime(crawl_time, format="%H:%M:%S"))) %>% group_by(crawl_time) %>% summarize(c=length(rd.rp.cmid)) %>% ggplot + geom_point(aes(x=crawl_time, y=c))
```

The crawling usually takes some time, that's why we have a lot of values on the x-axis. To have a better plot let's round it to the nearest half an hour.

```{r}
round_time <- function(time, mins){
  posix_time <- as.POSIXct(strptime(time, format="%H:%M:%S", tz="UTC"))
  as.POSIXct(strptime("1970-01-01", "%Y-%m-%d", tz="UTC") + round(as.numeric(posix_time)/(mins*60))*(mins*60))
}

data %>% separate(crawl_date, into=c("crawl_date","crawl_time"), sep =" ") %>% mutate(crawl_time=format(round_time(crawl_time,30), "%H:%M")) %>% group_by(crawl_time) %>% summarize(c=length(rd.rp.cmid)) %>% ggplot(aes(x=crawl_time, y=c)) + geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

The peak at 00:30 seems a bit suspicious. Let's investigate it more.

```{r}
data$rd.rp.hr %>% unique
```

Seeing this, now we are sure that it's the number of hours ago the report was created relative to the crawl time. We should take this into consideration instead of using the crawl time only.

```{r}
data <- (data %>% mutate(report_date=crawl_date - (rd.rp.hr*60*60) - (rd.rp.mn * 60) ))
```

And we don't need the old columns anymore

```{r}
data$rd.rp.hr <- NULL
data$rd.rp.mn <- NULL
data$crawl_date <- NULL
```

### Augmenting City names

Let's augment our data by the info of whether a certain road is in Alexandria and Cairo. By doing so, we would be able to start doing some comparisons between the two cities. Road ids of Cairo and Alex were fetched and parsed from by2ollak's HTML and written as CSV in `city_road_id.csv`.

```{r}
city_road <- read.csv("city_road_id.csv")
cairo_ids <- city_road[city_road$city == "cairo","rd.ri"]
alex_ids <- city_road[city_road$city == "alex","rd.ri"]

data <- (data %>% mutate(city= ifelse(rd.ri %in% cairo_ids, "cairo", ifelse(rd.ri %in% alex_ids, "alex", NA))))

#Manually fix some NAs that are not present in the HTML for some reason
data[data$rd.nm == "Makram 3ebeid;Autostrad To Mostafa ElNa7as",]$city <- "cairo"
data[data$rd.nm == "Gam3et ElDewal St;Sudan St To Sphinx",]$city <- "cairo"
data[data$rd.nm == "Tagamo3",]$city <- "cairo"
data[data$rd.nm == "توتال (برج العرب)",]$city <- "alex"
data[data$rd.nm == "Sa7rawy;Alex To Cairo",]$city <- "alex"
```

### Road Speed Dataset

By manually inspcting the website, you'll find a special username (@bey2ollakgps) who's always tweeting in a certain format about the speed between two points. Let's give it a look.

```{r}
(data %>% filter(grepl("bey2ollakgps", rd.rp.nm)))$rd.rp.cm %>% head
```

We can extract those speeds data into a seperate dataset for further analysis.

```{r}
speed_data <- ( data %>%
                 filter(grepl("bey2ollakgps", rd.rp.nm)) %>%
                 select(report_date,rd.nm, city, rd.rp.cm, rd.rp.stid)
              )

OVERALL_TOOK_REGEX <- "Overall took \\[(\\d+) min\\] with average speed \\[(\\d+) km/h\\]"
FROM_TO_REGEX <- "From \\[(.*)\\] to \\[(.*)\\] took \\[(\\d+) mins\\] with average speed \\[(\\d+) km/h\\]"
MN_ELA_REGEX <- "من \\[(.*)\\] إلى \\[(.*)\\] في \\[(\\d+) ق\\] ومتوسط سرعته \\[(\\d+) كم/س\\]"
ELTREE2_5AD_REGEX <- "الطريق أخد حوالي \\[(\\d+) ق\\] ومتوسط سرعته \\[(\\d+) كم/س\\]"
ROAD_REGEX <- "(.*);(.*) To (.*)"

tmp2 <- t(apply(speed_data, 1, function(x){

  tmp <- c(NA,NA,NA,NA)

  comment <- x["rd.rp.cm"]
  road_name <- x["rd.nm"]

  if(grepl(OVERALL_TOOK_REGEX, comment)) {
    tmp[1] <- gsub(ROAD_REGEX, "\\1;\\2", road_name)
    tmp[2] <- gsub(ROAD_REGEX, "\\1;\\3", road_name)
    tmp[3] <- gsub(OVERALL_TOOK_REGEX, "\\1", comment)
    tmp[4] <- gsub(OVERALL_TOOK_REGEX, "\\2", comment)
  }

  if(grepl(ELTREE2_5AD_REGEX, comment)) {
    tmp[1] <- gsub(ROAD_REGEX, "\\1;\\2", road_name)
    tmp[2] <- gsub(ROAD_REGEX, "\\1;\\3", road_name)
    tmp[3] <- gsub(ELTREE2_5AD_REGEX, "\\1", comment)
    tmp[4] <- gsub(ELTREE2_5AD_REGEX, "\\2", comment)
  }

  if(grepl(FROM_TO_REGEX, comment)) {
    tmp[1] <- gsub(FROM_TO_REGEX, "\\1", comment)
    tmp[2] <- gsub(FROM_TO_REGEX, "\\2", comment)
    tmp[3] <- gsub(FROM_TO_REGEX, "\\3", comment)
    tmp[4] <- gsub(FROM_TO_REGEX, "\\4", comment)
  }

  if(grepl(MN_ELA_REGEX, comment)) {
    tmp[1] <- gsub(MN_ELA_REGEX, "\\1", comment)
    tmp[2] <- gsub(MN_ELA_REGEX, "\\2", comment)
    tmp[3] <- gsub(MN_ELA_REGEX, "\\3", comment)
    tmp[4] <- gsub(MN_ELA_REGEX, "\\4", comment)
  }

  tmp
}))

speed_data$from <- tmp2[,1]
speed_data$to <- tmp2[,2]
speed_data$time <- tmp2[,3]
speed_data$speed <- tmp2[,4]

speed_data <- (speed_data %>% mutate(speed=as.integer(speed), time=as.integer(time)))
```

Let's have a look on our new dataset

```{r}
speed_data %>% sample_n(7) %>% kable
```

```{r}
(speed_data %>% mutate(from_to=paste(from,"->",to), speed=as.integer(speed)) %>% head(1000) %>% select(from_to, speed) %>% ggplot()) + geom_boxplot(aes(factor(from_to), speed)) + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

### Augmenting the Gender

I though that the gender may be a useful feature in our data so I got the first name of all the users and wrote a script to query an endpoint that can infer genders. The endpoint returns the estimated gender along with how confident it is from this answer. I selected only genders with high confidence. Then using a code, that's written in Go, each full name is matched with the longest first name it can and gets its gender. Attempting to do so in R was extremely slow because of Regex, so I implemented it using trie in Go. Let's add these info to our data.

```{r}
write.csv(data$rd.rp.fullnm, file="./name_manipulation/names.txt")
```

```{r, engine="bash"}
# Running the Go augmenter to output the (name,gender) pair
pushd ./name_manipulation
./full_name_gender
popd
```

```{r}
data$gender <- read.csv(file="./name_manipulation/output.txt")$gender
have_a_gender <- data %>% filter(!is.na(gender) & gender != "")
have_a_gender %>% select(rd.rp.nm, gender) %>% head(10) %>% kable
nrow(have_a_gender)
```

## Descriptive Analysis

### When do people usually report ?

```{r}
data %>% separate(report_date, into=c("report_date","report_time"), sep =" ") %>% mutate(report_time=format(round_time(report_time,30), "%H:%M")) %>% group_by(report_time) %>% summarize(c=length(rd.rp.cmid)) %>% arrange(desc(c)) %>% head %>% kable

data %>% separate(report_date, into=c("report_date","report_time"), sep =" ") %>% mutate(report_time=format(round_time(report_time,30), "%H:%M")) %>% group_by(report_time) %>% summarize(c=length(rd.rp.cmid)) %>% ggplot(aes(x=report_time, y=c)) + geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

The results shows that people use By2ollak the most when going from home to work (08:30am - 09:00am) and back to home (04:30pm - 06:00pm). Also notice that the period between (03:00am - 06:00am) is the quietest.

We can plot the distribution of reports against the week day.

```{r}
data %>% mutate(report_date=format(report_date, "%a")) %>% group_by(report_date) %>% summarize(c=length(rd.rp.cmid)) %>% mutate(c=(c/sum(c)*100)) %>% mutate(pos = cumsum(c)- c/2) %>% ggplot(aes(x="", y=c, fill=factor(report_date))) + geom_bar(width=1,stat='identity') + geom_text(aes(x="", y=pos, label=paste(format(round(c,2),nsmall=2), "%"))) + coord_polar(theta = "y") + theme(axis.text.x = element_blank())
```

Report day distribution isn't really significant as all the days are close to each other. The only significant thing is that Thursday is the highest with a margin probably as it's the weekend.

If we plot the number of reports segmented by the week day, you'll notice that the two peaks pattern we talked about earlier ( The work thing ) not there for weekends ( Friday and Saturday ).

```{r}

data %>% mutate(new_rep_date=report_date) %>% separate(new_rep_date, into=c("report_date_1","report_time"), sep =" ") %>% mutate(report_time=round_time(report_time,5), report_day=format(report_date, "%a")) %>% group_by(report_day, report_time) %>% summarize(c=length(rd.rp.cmid)) %>% ggplot(aes(x=report_time, y=c, color=factor(report_day))) + geom_line() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + facet_wrap(~report_day, nrow=7)

```


### What are the roads that gets the most reports ?

Let's plot the top 20 roads that get reports along with the type of reports that they get.
```{r}

highest_rp_roads <- (data %>% group_by(rd.nm) %>% summarize(c=length(rd.rp.cmid)) %>% arrange(desc(c)) %>% head(20))$rd.nm

data_to_plot <- (data %>% filter(rd.nm %in% highest_rp_roads) %>% filter(rd.rp.stid < 6) %>% group_by(rd.nm, rd.rp.stid) %>% summarize(c=length(rd.rp.cmid)))

stid_mapping <- c("7alawa","lazez","mashy","za7ma","mafesh amal","so2al","5atar","7adsa","3otl","m3loma")

stid_reports <- c("7alawa","lazez","mashy","za7ma","mafesh amal")

(data_to_plot %>% ggplot(aes(x=rd.nm, y=c, fill=factor(rd.rp.stid)))) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_discrete(labels=stid_reports, name="SS")
```

### Cairo Vs. Alex

Let's plot the percentage of reports in cairo compared to alex.

```{r}
data %>% group_by(city) %>% summarize(c=length(rd.rp.cmid)) %>% mutate(c=(c/sum(c)*100)) %>% mutate(pos = cumsum(c)- c/2) %>% ggplot(aes(x="", y=c, fill=factor(city))) + geom_bar(width=1,stat='identity') + geom_text(aes(x="", y=pos, label=paste(format(round(c,2),nsmall=2), "%"))) + coord_polar(theta = "y") + theme(axis.text.x = element_blank())
```

It seems like the number of people reporting in Cairo is much more than those who report in Alex.

Let's plot the number of reports in both cities against the time

```{r}
tmp_data <- data %>% separate(report_date, into=c("report_date","report_time"), sep =" ") %>% mutate(report_time=round_time(report_time,1)) %>% group_by(report_time,city) %>% summarize(c= length(rd.rp.stid)) %>% ungroup

tmp_data_cairo <- tmp_data %>% filter(city == "cairo")
tmp_data_alex <- tmp_data %>% filter(city == "alex")

ggplot() + geom_bar(data=tmp_data_cairo, aes(x=report_time,y=c, fill=city, color=city), stat="identity") + geom_bar(data=tmp_data_alex, aes(x=report_time,y=c, fill=city, color=city),stat="identity")
```

```{r}

tmp_data <- data %>% separate(report_date, into=c("report_date","report_time"), sep =" ") %>% mutate(report_time=round_time(report_time,1)) %>% group_by(report_time,city) %>% summarize(c= length(rd.rp.stid)) %>% ungroup

tmp_data_cairo <- tmp_data %>% filter(city == "cairo")
tmp_data_alex <- tmp_data %>% filter(city == "alex")

ggplot() + geom_line(data=tmp_data_cairo, aes(x=report_time,y=cumsum(c))) + geom_line(data=tmp_data_alex, aes(x=report_time,y=cumsum(c)))
```

From the two plots, the rush hours in alex isn't that segnificant like the one in cairo ( The two peaks ). Does this mean that there isn't heavy traffic in Alex even in rush hours? Let's check.

```{r}
data %>% filter(rd.rp.stid < 6 & !is.na(rd.rp.stid)) %>% separate(report_date, into=c("report_date","report_time"), sep =" ") %>% mutate(report_time=round_time(report_time,5)) %>% group_by(report_time,city) %>% summarize(average_stid= mean(rd.rp.stid)) %>% ggplot(aes(x=as.integer(report_time), y=average_stid, fill=city, color=city, shape=city)) + geom_point(size=2)  + geom_smooth() 
```

Between 9am and 10pm, the average reported status in cairo is always higher than that of Cairo. Alex seems like it's stable at status Id "2" which is "lazeez".


### Male Vs. Female

First of all, what's the ratio of female by2ollak users to male users ?

```{r}
have_a_gender %>% group_by(gender) %>% summarize(c=length(rd.rp.cmid)) %>% mutate(c=(c/sum(c)*100)) %>% mutate(pos = cumsum(c)- c/2) %>% ggplot(aes(x="", y=c, fill=factor(gender))) + geom_bar(width=1,stat='identity') + geom_text(aes(x="", y=pos, label=paste(format(round(c,2),nsmall=2), "%"))) + coord_polar(theta = "y") + theme(axis.text.x = element_blank())
```

Males in Egypt usually stay later at night than females, can we prove that from the number of reports of males/females against the time ?

```{r}
tmp_data <- have_a_gender %>% separate(report_date, into=c("report_date","report_time"), sep =" ") %>% mutate(report_time=round_time(report_time,2)) %>% group_by(report_time,gender) %>% summarize(c= length(rd.rp.cmid)) %>% ungroup

tmp_data_male <- tmp_data %>% filter(gender == "male")
tmp_data_female <- tmp_data %>% filter(gender == "female")

ggplot() + geom_bar(data=tmp_data_male, aes(x=report_time,y=c, fill=gender, color=gender), stat="identity") + geom_bar(data=tmp_data_female, aes(x=report_time,y=c, fill=gender, color=gender),stat="identity")

ggplot() + geom_line(data=tmp_data_male, aes(x=report_time,y=cumsum(c))) + geom_line(data=tmp_data_female, aes(x=report_time,y=cumsum(c)))
```

No. The group doesn't support our assumption.

## Suggested Hypotheses 

### Tendancy of those who ask to report

### People tend to report when it's crowded

hngeeb el two distributions of average_stid wel number of reports againest el time
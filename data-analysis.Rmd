---
title: Traffic Data Analysis
output: html_document
---

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(knitr)
```

## First Look on the data

First of all let's read the data

```{r cache=TRUE}
data <- read.csv("traffic-data.csv")
```

Now let's see some stats about the data

```{r}
data %>% dim
data %>% glimpse
data %>% head
data %>% summary
data %>% sapply(function(d) sum(is.na(d)))
```

## Let's Clean the data

Let's have a look at the uniqueness of the values in each column

```{r}
data %>% sapply(function(d) length(unique(d)))
```
All those columns with only one unique value are useless to our analysis as they don't distinguish between rows. Also it makes some sense as most of them are ads related and the ads seems to be the same throughout the whole data set. So we will remove all the ads related columns and those columns with only a single value.

```{r}
data$ad.aid <- NULL
data$ad.bgcl <- NULL
data$ad.bgcls <- NULL
data$ad.fncl <- NULL
data$ad.fncls <- NULL
data$ad.lid <- NULL
data$ad.logo <- NULL
data$ad.logo2x <- NULL
data$ad.logoAndroidS <- NULL
data$ad.logoAndroidH <- NULL
data$ad.cm <- NULL
data$ad.url <- NULL
data$ad.g <- NULL
data$rd.cl <- NULL
data$rd.img <- NULL
data$rd.rp.type <- NULL
```

According to the structure we saw above, dates are represented as factors. We can convert them to a better format using the `strptime` function and convert it a format that `dplyr` understands using the `as.POSIXct` function.

```{r}
data$crawl_date <- as.POSIXct(strptime(data$crawl_date,  format="%a %b %d %H:%M:%S UTC %y", tz="UTC"))
```

## Column Analysis

Now Let's have another look at the dataset columns and try to infer some info from the column names and values.

```{r}
data %>% glimpse
data %>% select(rd.new, rd.strq, rd.cmrq) %>% sapply(function(d) unique(d))
data %>% select(rd.new, rd.strq, rd.cmrq) %>% sapply(function(d) sum(d))
```

Those are my estimation for the columns meanings
```
crawl_date   # The date this data was crawled
rd.nm        # The Road name
rd.ri        # Seemed like the road id and was confirmed from By2ollak's HTML
rd.stid      # The Road Status Id ( Lazeez, ... ). Also confirmed from the HTML
rd.hr        # The road status last updated hour
rd.mn        # The road status last updated minute
rd.new       # Boolean values that needs some more investigation
rd.strq      # Another boolean value that needs investigation
rd.cmrq      # Another boolean value that needs investigation
rd.rp.nm     # Username of reporter
rd.rp.fullnm # Full name of reporter
rd.rp.hr     # Road report hours ago created
rd.rp.mn     # Road report minutes ago created
rd.rp.stid   # The reporter's reported road status
rd.rp.cm     # The reporter's comment
rd.rp.cmid   # Report id
rd.rp.rpImg  # Reporter img or whatever, also not useful
rd.rp.img    # Same as rd.rp.rpImg
```

One of those columns seems very interesting. It's the `rd.rp.cmid`. It's the column representing the report Id. Since these dataset is all about reports, this column's values should be globally unique across the whole dataset.

```{r}
data %>% dim
data$rd.rp.cmid %>% unique %>% length
```
Aaaaand It's not. That's due to the way the data was collected. A cronjob runs every 30 minutes to fetch the latest reports, but the same reports could be fetched multiple time specially if they are on an inactive road. Let's keep only the first copy of each report.

```{r}
data <- data[!(data$rd.rp.cmid %>% duplicated),]
```

## Let's Plot the timings!

Let's see the time people report the most

```{r}
data %>% separate(crawl_date, into=c("crawl_date","crawl_time"), sep =" ") %>% mutate(crawl_time=as.POSIXct(strptime(crawl_time, format="%H:%M:%S"))) %>% group_by(crawl_time) %>% summarize(c=length(rd.rp.cmid))  %>% ggplot + geom_point(aes(x=crawl_time, y=c))
```

The crawling usually takes some time, so to have a better plot let's round it to the nearest half an hour.

```{r}
round_time <- function(time){
  posix_time <- as.POSIXct(strptime(time, format="%H:%M:%S"))
  as.POSIXct(strptime("1970-01-01", "%Y-%m-%d", tz="UTC") + round(as.numeric(posix_time)/1800)*1800 + 60*60*2) # The added 60*60*2 is a hack to fix the TZ
}

data %>% separate(crawl_date, into=c("crawl_date","crawl_time"), sep =" ") %>% mutate(crawl_time=format(round_time(crawl_time), "%H:%M")) %>% group_by(crawl_time) %>% summarize(c=length(rd.rp.cmid)) %>% arrange(desc(c)) %>% head %>% kable

data %>% separate(crawl_date, into=c("crawl_date","crawl_time"), sep =" ") %>% mutate(crawl_time=round_time(crawl_time)) %>% group_by(crawl_time) %>% summarize(c=length(rd.rp.cmid)) %>% ggplot + geom_point(aes(x=crawl_time, y=c))
```

The results make sense as people will use By2ollak the most when going from home to work (~ 07:30am) and back to home. But the peak at 22:30 seems a bit suspicious and needs further investigation.


```{r}
#TODO FIX THE SORTING
data %>% mutate(crawl_date=format(crawl_date, "%a")) %>% group_by(crawl_date) %>% summarize(c=length(rd.rp.cmid)) %>% ggplot + geom_point(aes(x=crawl_date, y=c)) 
```

### Road Analysis

```{r}
(data %>% group_by(rd.nm) %>% summarize(c=length(rd.rp.cmid)) %>% arrange(desc(c)) %>% head(n=20) %>% ggplot) + geom_point(aes(x=rd.nm, y=c, size=c)) + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

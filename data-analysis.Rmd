---
title: "Traffic Data Analysis"
output: html_document
---

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(knitr)
library(stringr)
```

## First Look on the data

First of all let's read the data

```{r cache=TRUE}
data <- read.csv("traffic-data.csv")
```

Now let's see some stats about the data

```{r}
data %>% dim
data %>% glimpse
data %>% head
data %>% summary
data %>% sapply(function(d) sum(is.na(d)))
```

## Let's Clean the data

Let's have a look at the uniqueness of the values in each column

```{r}
data %>% sapply(function(d) length(unique(d)))
```
All those columns with only one unique value are useless to our analysis as they don't distinguish between rows. Also it makes some sense as most of them are ads related and the ads seems to be the same throughout the whole data set. So we will remove all the ads related columns and those columns with only a single value.

```{r}

data <- (
         data %>% select(-c(
                            ad.aid,
                            ad.bgcl,
                            ad.bgcls,
                            ad.fncl,
                            ad.fncls,
                            ad.lid,
                            ad.logo,
                            ad.logo2x,
                            ad.logoAndroidS,
                            ad.logoAndroidH,
                            ad.cm,
                            ad.url,
                            ad.g,
                            rd.cl,
                            rd.img,
                            rd.rp.type,
                            rd.rp.rpImg,
                            rd.rp.img
                            )
         )
 )
```

According to the structure we saw above, dates are represented as factors. We can convert them to a better format using the `strptime` function and convert it a format that `dplyr` understands using the `as.POSIXct` function.

```{r}
data$crawl_date <- as.POSIXct(strptime(data$crawl_date,  format="%a %b %d %H:%M:%S UTC %Y", tz="UTC"))
```

## Column Analysis

Now Let's have another look at the dataset columns and try to infer some info from the column names and values.

```{r}
data %>% glimpse
data %>% select(rd.new, rd.strq, rd.cmrq) %>% sapply(function(d) unique(d))
```

The `rd.strq` and `rd.cmrq` are boolean properties of the road. After some investigation, I found that they don't have any presence in the HTML/JS of the desktop version of By2ollak. My guess would be that they are for the mobile version to determine whether choosing a status/adding a comment is required or not when leaving a report. This would be confirmed if there isn't any road who has this flag both set and unset in the same dataset. In other words, the set containing the roads who has the flag set doesn't intersect with the one with the flag unset.

```{r, collapse=TRUE}
data %>% group_by(rd.strq) %>% summarize(c=length(unique(rd.nm)))
sum((data %>% group_by(rd.strq) %>% summarize(c=length(unique(rd.nm))))$c) == (data$rd.nm %>% unique %>% length)

data %>% group_by(rd.cmrq) %>% summarize(c=length(unique(rd.nm)))
sum((data %>% group_by(rd.cmrq) %>% summarize(c=length(unique(rd.nm))))$c) == (data$rd.nm %>% unique %>% length)

data %>% group_by(rd.new) %>% summarize(c=length(unique(rd.nm)))
sum((data %>% group_by(rd.cmrq) %>% summarize(c=length(unique(rd.nm))))$c) == (data$rd.nm %>% unique %>% length)
```

The guess seems to be correct. That's why those columns are not important to us any more.

```{r}
data <- (data %>% select(-c(rd.strq, rd.cmrq, rd.new)))
```

Those are my estimation for the columns meanings
```
crawl_date   # The date this data was crawled
rd.nm        # The Road name
rd.ri        # Seemed like the road id and was confirmed from By2ollak's HTML
rd.stid      # The Road Status Id ( Lazeez, ... ). Also confirmed from the HTML
rd.hr        # The road status last updated hour
rd.mn        # The road status last updated minute
rd.rp.nm     # Username of reporter
rd.rp.fullnm # Full name of reporter
rd.rp.hr     # Road report hours ago created
rd.rp.mn     # Road report minutes ago created
rd.rp.stid   # The reporter's reported road status
rd.rp.cm     # The reporter's comment
rd.rp.cmid   # Report id
```


One of those columns seems very interesting. It's the `rd.rp.cmid`. It's the column representing the report Id. Since these dataset is all about reports, this column's values should be globally unique across the whole dataset.

```{r}
data %>% dim
data$rd.rp.cmid %>% unique %>% length
```
Aaaaand It's not. That's due to the way the data was collected. A cronjob runs every 30 minutes to fetch the latest reports, but the same reports could be fetched multiple time specially if they are on an inactive road. Let's keep only the first copy of each report.

```{r}
data <- data[!(data$rd.rp.cmid %>% duplicated),]
```

## Let's Plot the timings!

Let's see the time people report the most

```{r}
data %>% separate(crawl_date, into=c("crawl_date","crawl_time"), sep =" ") %>% mutate(crawl_time=as.POSIXct(strptime(crawl_time, format="%H:%M:%S"))) %>% group_by(crawl_time) %>% summarize(c=length(rd.rp.cmid))  %>% ggplot + geom_point(aes(x=crawl_time, y=c))
```

The crawling usually takes some time, that's why we have a lot of values on the x-axis. To have a better plot let's round it to the nearest half an hour.

```{r}
round_time <- function(time){
  posix_time <- as.POSIXct(strptime(time, format="%H:%M:%S"))
  as.POSIXct(strptime("1970-01-01", "%Y-%m-%d", tz="UTC") + round(as.numeric(posix_time)/1800)*1800 + 60*60*2) # The added 60*60*2 is a hack to fix the TZ
}

data %>% separate(crawl_date, into=c("crawl_date","crawl_time"), sep =" ") %>% mutate(crawl_time=round_time(crawl_time)) %>% group_by(crawl_time) %>% summarize(c=length(rd.rp.cmid)) %>% ggplot(aes(x=crawl_time, y=c)) + geom_bar(stat='identity')
```

The peak at 22:30 seems a bit suspicious. Let's investigate it more.

```{r}
data$rd.rp.hr %>% unique
```

Seeing this, now we are sure that it's the number of hours ago the report was created relative to the crawl time. We should take this into consideration instead of using the crawl time only.

```{r}

data <- (data %>% mutate(report_date=crawl_date - (rd.rp.hr*60*60) - (rd.rp.mn * 60) ))
# We don't need those columns anymore
data$rd.rp.hr <- NULL
data$rd.rp.mn <- NULL
data$crawl_date <- NULL

data %>% separate(report_date, into=c("report_date","report_time"), sep =" ") %>% mutate(report_time=format(round_time(report_time), "%H:%M")) %>% group_by(report_time) %>% summarize(c=length(rd.rp.cmid)) %>% arrange(desc(c)) %>% head %>% kable

data %>% separate(report_date, into=c("report_date","report_time"), sep =" ") %>% mutate(report_time=format(round_time(report_time), "%H:%M")) %>% group_by(report_time) %>% summarize(c=length(rd.rp.cmid)) %>% ggplot(aes(x=report_time, y=c)) + geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

The results make sense as people will use By2ollak the most when going from home to work (06:30am - 07:00am) and back to home (02:30pm - 04:00pm) and those are the peaks in the plot. Also notice that the period between (01:00am - 04:00am) is the quietest.


```{r}
data %>% mutate(report_date=format(report_date, "%a")) %>% group_by(report_date) %>% summarize(c=length(rd.rp.cmid)) %>% mutate(c=(c/sum(c)*100)) %>% mutate(pos = cumsum(c)- c/2) %>% ggplot(aes(x="", y=c, fill=factor(report_date))) + geom_bar(width=1,stat='identity') + geom_text(aes(x="", y=pos, label=paste(format(round(c,2),nsmall=2), "%"))) + coord_polar(theta = "y")
```

Report day distribution isn't really significant as all the days are close to each other. The only significant thing is that Thursday is the highest with a margin probably as it's the weekend.

### Road Analysis

Let's plot the top 20 roads that get reports along with the type of reports that they get.
```{r}

highest_rp_roads <- (data %>% group_by(rd.nm) %>% summarize(c=length(rd.rp.cmid)) %>% arrange(desc(c)) %>% head(20))$rd.nm

data_to_plot <- (data %>% filter(rd.nm %in% highest_rp_roads) %>% filter(rd.rp.stid < 6) %>% group_by(rd.nm, rd.rp.stid) %>% summarize(c=length(rd.rp.cmid)))

stid_mapping <- c("7alawa","lazez","mashy","za7ma","mafesh amal","so2al","5atar","7adsa","3otl","m3loma")

stid_reports <- c("7alawa","lazez","mashy","za7ma","mafesh amal")

(data_to_plot %>% ggplot(aes(x=rd.nm, y=c, fill=factor(rd.rp.stid)))) + geom_bar(stat="identity") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_fill_discrete(labels=stid_reports, name="SS")
```

By manually inspcting the website, you'll find a special username (@bey2ollakgps) who's always tweeting in a certain format about the speed between two points. Let's give it a look.

```{r}
(data %>% filter(grepl("bey2ollakgps", rd.rp.nm)))$rd.rp.cm %>% head
```

We can extract those speeds data into a seperate dataset for further analysis.

```{r}
speed_data <- ( data %>%
                 filter(grepl("bey2ollakgps", rd.rp.nm)) %>%
                 select(report_date,rd.nm, rd.rp.cm, rd.rp.stid)
              )

OVERALL_TOOK_REGEX <- "Overall took \\[(\\d+) min\\] with average speed \\[(\\d+) km/h\\]"
FROM_TO_REGEX <- "From \\[(.*)\\] to \\[(.*)\\] took \\[(\\d+) mins\\] with average speed \\[(\\d+) km/h\\]"
MN_ELA_REGEX <- "من \\[(.*)\\] إلى \\[(.*)\\] في \\[(\\d+) ق\\] ومتوسط سرعته \\[(\\d+) كم/س\\]"
ELTREE2_5AD_REGEX <- "الطريق أخد حوالي \\[(\\d+) ق\\] ومتوسط سرعته \\[(\\d+) كم/س\\]"
ROAD_REGEX <- "(.*);(.*) To (.*)"

tmp2 <- t(apply(speed_data, 1, function(x){

  tmp <- c(NA,NA,NA,NA)

  comment <- x["rd.rp.cm"]
  road_name <- x["rd.nm"]

  if(grepl(OVERALL_TOOK_REGEX, comment)) {
    tmp[1] <- gsub(ROAD_REGEX, "\\1;\\2", road_name)
    tmp[2] <- gsub(ROAD_REGEX, "\\1;\\3", road_name)
    tmp[3] <- gsub(OVERALL_TOOK_REGEX, "\\1", comment)
    tmp[4] <- gsub(OVERALL_TOOK_REGEX, "\\2", comment)
  }

  if(grepl(ELTREE2_5AD_REGEX, comment)) {
    tmp[1] <- gsub(ROAD_REGEX, "\\1;\\2", road_name)
    tmp[2] <- gsub(ROAD_REGEX, "\\1;\\3", road_name)
    tmp[3] <- gsub(ELTREE2_5AD_REGEX, "\\1", comment)
    tmp[4] <- gsub(ELTREE2_5AD_REGEX, "\\2", comment)
  }

  if(grepl(FROM_TO_REGEX, comment)) {
    tmp[1] <- gsub(FROM_TO_REGEX, "\\1", comment)
    tmp[2] <- gsub(FROM_TO_REGEX, "\\2", comment)
    tmp[3] <- gsub(FROM_TO_REGEX, "\\3", comment)
    tmp[4] <- gsub(FROM_TO_REGEX, "\\4", comment)
  }

  if(grepl(MN_ELA_REGEX, comment)) {
    tmp[1] <- gsub(MN_ELA_REGEX, "\\1", comment)
    tmp[2] <- gsub(MN_ELA_REGEX, "\\2", comment)
    tmp[3] <- gsub(MN_ELA_REGEX, "\\3", comment)
    tmp[4] <- gsub(MN_ELA_REGEX, "\\4", comment)
  }

  tmp
}))

speed_data$from <- tmp2[,1]
speed_data$to <- tmp2[,2]
speed_data$time <- tmp2[,3]
speed_data$speed <- tmp2[,4]

speed_data <- (speed_data %>% mutate(speed=as.integer(speed), time=as.integer(time)))
```

Let's have a look on our new dataset

```{r}
speed_data %>% sample_n(10) %>% kable
```

```{r}
(speed_data %>% mutate(from_to=paste(from,"->",to), speed=as.integer(speed)) %>% head(1000) %>% select(from_to, speed) %>% ggplot()) + geom_boxplot(aes(factor(from_to), speed)) + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

# City analysis

Let's augment our data by the info of whether a certain road is in Alexandria and Cairo. By doing so, we would be able to start doing some comparisons between the two cities. Road ids of Cairo and Alex were fetched and parsed from by2ollak's HTML and written as CSV in `city_road_id.csv`.

```{r}
city_road <- read.csv("city_road_id.csv")
cairo_ids <- city_road[city_road$city == "cairo","rd.ri"]
alex_ids <- city_road[city_road$city == "alex","rd.ri"]

data <- (data %>% mutate(city= ifelse(rd.ri %in% cairo_ids, "cairo", ifelse(rd.ri %in% alex_ids, "alex", NA))))

#Manually fix some NAs that are not present in the HTML for some reason
data[data$rd.nm == "Makram 3ebeid;Autostrad To Mostafa ElNa7as",]$city <- "cairo"
data[data$rd.nm == "Gam3et ElDewal St;Sudan St To Sphinx",]$city <- "cairo"
data[data$rd.nm == "Tagamo3",]$city <- "cairo"
data[data$rd.nm == "توتال (برج العرب)",]$city <- "alex"
data[data$rd.nm == "Sa7rawy;Alex To Cairo",]$city <- "alex"
```

Let's plot the percentage of reports in cairo compared to alex.

```{r}
data %>% group_by(city) %>% summarize(c=length(rd.rp.cmid)) %>% mutate(c=(c/sum(c)*100)) %>% mutate(pos = cumsum(c)- c/2) %>% ggplot(aes(x="", y=c, fill=factor(city))) + geom_bar(width=1,stat='identity') + geom_text(aes(x="", y=pos, label=paste(format(round(c,2),nsmall=2), "%"))) + coord_polar(theta = "y")
```

It seems like the number of people reporting in Cairo is much more than those who report in Alex.

